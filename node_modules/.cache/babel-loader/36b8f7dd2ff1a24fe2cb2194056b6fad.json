{"ast":null,"code":"var _jsxFileName = \"/home/paula/Documents/Practica/git/user_interface/src/components/InferenceUI/WebcamStream.js\";\nimport './InferenceUI.css';\nimport React from 'react';\nimport { Button, Alert } from 'reactstrap'; // Agregar variable para almacenar la hora en que se apretó el start.\n// Administrar el fullscreen desde acá ahora.\n\nclass WebcamStream extends React.Component {\n  constructor(props) {\n    super();\n    this.state = {\n      isVideoLoading: true\n    };\n    this.videoTag = React.createRef();\n    this.canvasPreview = React.createRef();\n    this.selectVideoSrc = React.createRef();\n    this.tick = this.tick.bind(this);\n    this.mediaRecorder = null;\n    this.recordedChunks = [];\n    this.videoRecorded = null;\n  }\n\n  listDevices() {\n    navigator.mediaDevices.enumerateDevices().then(deviceInfos => {\n      this.selectVideoSrc.current.innerHTML = '';\n      let count = 1;\n      deviceInfos.forEach(deviceInfo => {\n        const option = document.createElement('option');\n        option.value = deviceInfo.deviceId;\n\n        if (deviceInfo.kind === 'videoinput') {\n          option.text = deviceInfo.label || `Camera ${count++}`;\n          this.selectVideoSrc.current.appendChild(option);\n        }\n      });\n    });\n  }\n\n  setStream() {\n    // Falta cerrar el stream anterior antes de abrir uno nuevo.\n    navigator.mediaDevices.getUserMedia({\n      video: {\n        deviceId: this.selectVideoSrc.current.value ? {\n          exact: this.selectVideoSrc.current.value\n        } : undefined,\n        facingMode: \"enviroment\"\n      }\n    }).then(stream => {\n      this.videoTag.current.srcObject = stream;\n      requestAnimationFrame(this.tick);\n      window.stream = stream;\n      var options = {\n        mimeType: \"video/webm;codecs=vp8\"\n      };\n      this.mediaRecorder = new MediaRecorder(stream, options);\n    });\n  }\n\n  componentDidMount() {\n    this.listDevices();\n  }\n\n  tick() {\n    const video = this.videoTag.current;\n    const checkVideoState = setInterval(() => {\n      if (video.readyState === video.HAVE_ENOUGH_DATA) {\n        clearInterval(checkVideoState);\n        this.setState({\n          isVideoLoading: false\n        });\n        const canvasPreviewElement = this.canvasPreview.current;\n\n        if (canvasPreviewElement) {\n          const canvasPreview = canvasPreviewElement.getContext(\"2d\");\n          canvasPreviewElement.height = video.videoHeight;\n          canvasPreviewElement.width = video.videoWidth;\n          canvasPreview.drawImage(video, 0, 0, canvasPreviewElement.width, canvasPreviewElement.height);\n\n          if (this.props.currentState.almostStreaming) {\n            canvasPreview.font = \"200px Arial\";\n            countdown(canvasPreview, this);\n          }\n\n          requestAnimationFrame(this.tick);\n        }\n      }\n    }, 50);\n  } //For making video recording\n\n\n  handleDataAvailable(event) {\n    console.log('handleDataAvailable', event);\n\n    if (event.data && event.data.size > 0) {\n      this.recordedChunks.push(event.data);\n      var blob = new Blob(this.recordedChunks, {\n        type: \"video/webm\"\n      });\n      this.videoRecorded = URL.createObjectURL(blob);\n    } else {\n      console.log(\"no data available for recording\");\n    }\n  }\n\n  startRecording() {\n    this.mediaRecorder.ondataavailable = this.handleDataAvailable;\n    this.mediaRecorder.start();\n    this.props.getVideoThumbnail(this.canvasPreview.current.toDataURL(\"image/jpeg\", 1));\n  }\n\n  stopRecording() {\n    this.mediaRecorder.stop();\n  }\n\n  downloadVideo() {\n    var aux = document.createElement(\"a\");\n    document.body.appendChild(aux);\n    aux.style = \"display: none\";\n    aux.href = this.videoRecorded;\n    aux.download = \"test.webm\";\n    document.body.appendChild(aux);\n    aux.click();\n  }\n\n  render() {\n    const isVideoLoading = this.state.isVideoLoading;\n    return /*#__PURE__*/React.createElement(\"div\", {\n      className: \"WebcamStream_Wrapper\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 128,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(\"video\", {\n      ref: this.videoTag,\n      autoPlay: true,\n      id: \"video\",\n      style: {\n        display: \"none\"\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 130,\n        columnNumber: 9\n      }\n    }), !isVideoLoading && /*#__PURE__*/React.createElement(\"div\", {\n      id: \"mainDiv\",\n      className: \"container mainDiv\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 138,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      id: \"canvasDiv\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 139,\n        columnNumber: 13\n      }\n    }, this.props.currentState.canvasAlert && /*#__PURE__*/React.createElement(\"div\", {\n      id: \"alert\",\n      style: {\n        position: 'absolute',\n        zIndex: 2\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 141,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(Alert, {\n      color: \"warning\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 142,\n        columnNumber: 19\n      }\n    }, \"Verifique el enfoque del dispositivo.\")), this.props.currentState.stateName.localeCompare(\"GetCon\") === 0 && /*#__PURE__*/React.createElement(\"div\", {\n      id: \"alert\",\n      style: {\n        position: 'absolute',\n        zIndex: 2\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 147,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(Alert, {\n      color: \"info\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 148,\n        columnNumber: 19\n      }\n    }, \"Estableciendo conexi\\xF3n con el servidor.\")), this.props.currentState.renderCanvas && /*#__PURE__*/React.createElement(\"div\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 153,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"canvas\", {\n      ref: this.canvasPreview,\n      id: \"canvasPreview\",\n      className: \"canvasPreview\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 154,\n        columnNumber: 19\n      }\n    })), !this.props.currentState.renderCanvas && /*#__PURE__*/React.createElement(\"video\", {\n      controls: true,\n      src: this.videoRecorded,\n      width: \"640px\",\n      height: \"480px\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 160,\n        columnNumber: 17\n      }\n    }))), isVideoLoading && /*#__PURE__*/React.createElement(\"p\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 171,\n        columnNumber: 11\n      }\n    }, \"Seleccione un dispositivo de imagen en el panel de configuraci\\xF3n.\"), /*#__PURE__*/React.createElement(\"div\", {\n      id: \"videoSelectDiv\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 173,\n        columnNumber: 5\n      }\n    }, /*#__PURE__*/React.createElement(Button, {\n      color: \"primary\",\n      onClick: () => {\n        this.listDevices();\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 174,\n        columnNumber: 11\n      }\n    }, \"Refrescar\"), /*#__PURE__*/React.createElement(\"select\", {\n      ref: this.selectVideoSrc,\n      style: {\n        width: 300\n      },\n      id: \"videoSelect\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 177,\n        columnNumber: 6\n      }\n    }), /*#__PURE__*/React.createElement(Button, {\n      color: \"primary\",\n      onClick: () => {\n        this.setStream();\n      },\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 180,\n        columnNumber: 6\n      }\n    }, \"Ok\")));\n  }\n\n}\n\nfunction countdown(canvas, el) {\n  let context = canvas;\n  let countdown = el.props.countdownFrom - Math.trunc((-el.props.currentState.timeStartPressed + Date.now()) / 1000);\n  context.beginPath();\n  context.arc(320, 240, 130, 0, 2 * Math.PI);\n  context.fillStyle = \"rgba(255, 255, 255, 0.8)\";\n  ;\n  context.fill();\n  context.beginPath();\n  context.fillStyle = \"black\";\n\n  if (countdown >= 10) {\n    context.fillText(countdown.toString(10), 200, 315);\n  } else if (countdown >= 1) {\n    context.fillText(countdown.toString(10), 270, 308, 100);\n  }\n\n  context.fill();\n\n  if (countdown < 1) {\n    // el.props.currentState.almostStreaming = false;\n    // el.props.currentState.streaming = true;\n    el.props.handler(\"Examination\");\n  }\n}\n\nexport default WebcamStream;","map":{"version":3,"sources":["/home/paula/Documents/Practica/git/user_interface/src/components/InferenceUI/WebcamStream.js"],"names":["React","Button","Alert","WebcamStream","Component","constructor","props","state","isVideoLoading","videoTag","createRef","canvasPreview","selectVideoSrc","tick","bind","mediaRecorder","recordedChunks","videoRecorded","listDevices","navigator","mediaDevices","enumerateDevices","then","deviceInfos","current","innerHTML","count","forEach","deviceInfo","option","document","createElement","value","deviceId","kind","text","label","appendChild","setStream","getUserMedia","video","exact","undefined","facingMode","stream","srcObject","requestAnimationFrame","window","options","mimeType","MediaRecorder","componentDidMount","checkVideoState","setInterval","readyState","HAVE_ENOUGH_DATA","clearInterval","setState","canvasPreviewElement","getContext","height","videoHeight","width","videoWidth","drawImage","currentState","almostStreaming","font","countdown","handleDataAvailable","event","console","log","data","size","push","blob","Blob","type","URL","createObjectURL","startRecording","ondataavailable","start","getVideoThumbnail","toDataURL","stopRecording","stop","downloadVideo","aux","body","style","href","download","click","render","display","canvasAlert","position","zIndex","stateName","localeCompare","renderCanvas","canvas","el","context","countdownFrom","Math","trunc","timeStartPressed","Date","now","beginPath","arc","PI","fillStyle","fill","fillText","toString","handler"],"mappings":"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","sourcesContent":["import './InferenceUI.css'\nimport React from 'react';\nimport {Button, Alert} from 'reactstrap';\n\n// Agregar variable para almacenar la hora en que se apretó el start.\n// Administrar el fullscreen desde acá ahora.\nclass WebcamStream extends React.Component {\n  constructor(props) {\n    super();\n    this.state = {\n      isVideoLoading: true      \n    };\n\n    this.videoTag = React.createRef();\n    this.canvasPreview = React.createRef();\n\t\tthis.selectVideoSrc = React.createRef();\n    this.tick = this.tick.bind(this);\n\n    this.mediaRecorder = null;\n    this.recordedChunks= [];\n\t  this.videoRecorded = null;\n  }\n\n  listDevices(){\n    navigator.mediaDevices.enumerateDevices()\n    .then((deviceInfos) => {\n      this.selectVideoSrc.current.innerHTML = '';\n      let count = 1;\n      deviceInfos.forEach( deviceInfo => {\n        const option = document.createElement('option');\n        option.value = deviceInfo.deviceId;\n        if (deviceInfo.kind === 'videoinput') {\n          option.text = deviceInfo.label || `Camera ${count++}`;\n          this.selectVideoSrc.current.appendChild(option);\n        }\n      });\n    });\n  }\n\n  setStream(){\n    // Falta cerrar el stream anterior antes de abrir uno nuevo.\n    navigator.mediaDevices.getUserMedia({\n      video: {\n        deviceId: this.selectVideoSrc.current.value? {exact: this.selectVideoSrc.current.value}:undefined,\n        facingMode: \"enviroment\"\n      }\n    }).then(stream => {\n      this.videoTag.current.srcObject = stream;\n      requestAnimationFrame(this.tick);\n      window.stream = stream;\n      var options = { mimeType: \"video/webm;codecs=vp8\" };\n      this.mediaRecorder = new MediaRecorder(stream, options);\n    });\n  }\n\n  componentDidMount() {\n    this.listDevices();\n  }\n\n  tick() {\n    const video = this.videoTag.current;\n    const checkVideoState = setInterval(() => {\n      if (video.readyState === video.HAVE_ENOUGH_DATA) {\n        clearInterval(checkVideoState);\n\n        this.setState({ isVideoLoading: false });\n          const canvasPreviewElement = this.canvasPreview.current;\n          if(canvasPreviewElement){\n          const canvasPreview = canvasPreviewElement.getContext(\"2d\");\n\n          canvasPreviewElement.height = video.videoHeight;\n          canvasPreviewElement.width = video.videoWidth;\n          canvasPreview.drawImage(\n              video,\n              0,\n              0,\n              canvasPreviewElement.width,\n              canvasPreviewElement.height\n           );\n           if(this.props.currentState.almostStreaming){\n             canvasPreview.font = \"200px Arial\"\n             countdown(canvasPreview,this);\n           }\n           requestAnimationFrame(this.tick);\n           }\n      }\n    }, 50);\n  }\n\n  //For making video recording\n  handleDataAvailable(event){\n\t\tconsole.log('handleDataAvailable',event);\n  \tif (event.data && event.data.size > 0) {\n      this.recordedChunks.push(event.data);\n      var blob = new Blob(this.recordedChunks, {\n        type: \"video/webm\"\n      });\n      this.videoRecorded = URL.createObjectURL(blob);\n  \t}\n\t\telse {\n    \tconsole.log(\"no data available for recording\");\n  \t}\n  }\n\n  startRecording(){\n      this.mediaRecorder.ondataavailable = this.handleDataAvailable;\n      this.mediaRecorder.start();\n      this.props.getVideoThumbnail(this.canvasPreview.current.toDataURL(\"image/jpeg\",1));\n  }\n\n\tstopRecording(){\n    this.mediaRecorder.stop();\n\t}\n\n\tdownloadVideo(){\n\t\tvar aux = document.createElement(\"a\");\n\t\tdocument.body.appendChild(aux);\n\t\taux.style = \"display: none\";\n\t\taux.href = this.videoRecorded;\n    aux.download = \"test.webm\";\n    document.body.appendChild(aux);\n\t\taux.click();\t\t\n\t}\n\n  render() {\n    const isVideoLoading = this.state.isVideoLoading;\n    return (\n      <div className=\"WebcamStream_Wrapper\">\n        {/* Dummy video tag to recieve UserMedia stream.*/}\n        <video\n          ref={this.videoTag}\n          autoPlay\n          id = \"video\"\n          style={{ display: \"none\"}}\n        />\n\n        {!isVideoLoading &&\n          <div  id=\"mainDiv\" className=\"container mainDiv\">\n            <div id=\"canvasDiv\">\n              {this.props.currentState.canvasAlert &&\n                <div id=\"alert\" style={{position: 'absolute', zIndex: 2}}>\n                  <Alert color=\"warning\">Verifique el enfoque del dispositivo.</Alert>\n                </div>\n              }\n\n              {this.props.currentState.stateName.localeCompare(\"GetCon\") === 0 &&\n                <div id=\"alert\" style={{position: 'absolute', zIndex: 2}}>\n                  <Alert color=\"info\">Estableciendo conexión con el servidor.</Alert>\n                </div>\n              }\n              \n              {this.props.currentState.renderCanvas &&\n                <div>\n                  <canvas ref={this.canvasPreview}\n                          id=\"canvasPreview\"\n                          className = \"canvasPreview\"/>\n                </div>\n              }\n              {!this.props.currentState.renderCanvas &&\n                <video\n                  controls\n                  src={this.videoRecorded}\n                  width=\"640px\"\n                  height=\"480px\"\n                />\n              }\n            </div>\n          </div>\n        }\n        {isVideoLoading &&\n          <p>Seleccione un dispositivo de imagen en el panel de configuración.</p>\n        }\n\t\t\t\t<div id=\"videoSelectDiv\">\n          <Button color ='primary'\n                  onClick={()=>{this.listDevices();}}\n          >Refrescar</Button>\n\t\t\t\t\t<select ref={this.selectVideoSrc}\n\t\t\t\t\t\t\t\t\tstyle={{width: 300}}\n\t\t\t\t\t\t\t\t\tid=\"videoSelect\"/>\n\t\t\t\t\t<Button color='primary'\n                  onClick={()=>{this.setStream();}}\n          >Ok</Button>\n\t\t\t\t</div>\n      </div>\n    );\n  }\n}\n\nfunction countdown(canvas,el){\n\tlet context = canvas;\t\n\tlet countdown = el.props.countdownFrom- Math.trunc((-el.props.currentState.timeStartPressed + Date.now())/1000);\n  context.beginPath();\n  context.arc(320, 240, 130, 0, 2 * Math.PI);\n  context.fillStyle = \"rgba(255, 255, 255, 0.8)\";;\n  context.fill();\n  context.beginPath();\n  context.fillStyle = \"black\";\n  if(countdown >= 10){\n    context.fillText(countdown.toString(10),200,315);\n  }else if(countdown >= 1){\n    context.fillText(countdown.toString(10),270,308,100);\n  }\n\n  context.fill();\n  if (countdown <  1){\n    // el.props.currentState.almostStreaming = false;\n    // el.props.currentState.streaming = true;\n\t\tel.props.handler(\"Examination\");\n  }\n}\nexport default WebcamStream;\n"]},"metadata":{},"sourceType":"module"}